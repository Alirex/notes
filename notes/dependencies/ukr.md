# Dependencies / Залежності

Вказуємо та закріплюємо залежності у Python.

Щось може бути актуальним і для інших мов.

---

# Dependency management / Керування залежностями

Можна використовувати будь-що з екосистеми для фіксації / закріплення залежностей.
Головне їх фіксувати.
Тобто вказувати та зберігати.

Також, якщо використовується Docker, то це також може значно покращити повторюваність розгортання вашого інструменту.
Пам’ятайте, що у Docker ви можете вказувати версії також для системних залежностей.
Якщо це потрібно.
У якомусь сенсі, Dockerfile — це один з етапів фіксації залежності.

Додатково:

- https://12factor.net/dependencies

## Pinned versions / Закріплені версії

Залежності краще вказувати з явними версіями. А не wildcards (\*) чи подібне.

Іноді, може мати сенс, навіть зафіксувати конкретну версію (наприклад, `requests==2.28.1`).

Але, щонайменше, укажіть нижню границю (наприклад, `requests>=2.28.1`).
У деяких інструментах це вказується автоматично.
І можна не вказувати версію під час додання залежності.

Більше про версії:

- Semantic Versioning
  - https://semver.org/
- Zero Versioning
  - https://0ver.org/
- Calendar Versioning
  - https://calver.org/

## Pin early / Закріплюйте раніше

Раджу вказувати залежності якомога раніше.

Як варіант, можна навіть спочатку вказати залежність у файлі із залежностями,
а потім встановити залежності із цього файлу.
Це значно підвищує шанси на те, що всі залежності будуть вказані.

На випадок, якщо для ваших залежностей потрібні якісь системні залежності, є сенс додати кудись інформацію про їх
встановлення.
Може, навіть, з версією.
Наприклад, у Readme/Justfile/Makefile/etc.

## Few environments / Декілька оточень

У деяких випадках ви можете розділяти залежності на декілька оточень. Під декілька варіантів використання.

Десь це може бути у одному файлі, десь через декілька.

Наприклад, у випадку з декількома файлами:

- base
  - із залежностями, які завжди потрібні
- dev (чи local)
  - використовує base
  - із залежностями, які потрібні тільки під час розробки.
    - наприклад, якісь особливі лінтери
- prod (чи production)
  - використовує base
  - із залежностями, які потрібні тільки для production
    - наприклад веб-сервер

Іноді всі залежності знаходяться в одному файлі. І там є дві секції. Одна — головна. Це як “base + prod”. І допоміжна
“dev”.

Іноді залежності можна розділити по групах.

Подібне розділення може зменшити кількість залежностей, які встановлюються на production. Чи, коли вони не потрібні.

Але, в ідеалі, краще щоб різниця між prod та dev була мінімальна.

Докладніше:

- https://12factor.net/dev-prod-parity

## Describe / Описуйте

Якщо є можливість, раджу робити коментарі щодо того, навіщо ви додали ту, чи іншу залежність (чи группу залежностей).

У деяких файлах з залежностями ви можете залишати коментарі прямо поряд з залежностями. Наприклад у:

- txt
- toml
- yaml

У деяких файлах ви це робити не можете.
Наприклад, у json.
Тоді, як варіант, для деяких інструментів ви можете зробити додаткову секцію у файлі. Наприклад:

```json
{
  "_comments": {
    "dependencies": {
      "dependency-1": "Your description",
      "dependency-group-1": {
        "items": ["dependency-2", "dependency-3"],
        "description": "Your description"
      }
    },
    "other": {
      "Something": "Notes"
    }
  },
  "dependencies": {
    "dependency-1": "1.2.3",
    "dependency-2": "4.5.6",
    "dependency-3": "7.8.9"
  }
}
```

## Freeze (optional) / Заморожуйте (опціонально)

У деяких інструментах з керуванням залежностями є можливість фіксувати всі залежності.
Зокрема залежності ваших залежностей.
І це може бути корисним.
Іноді дуже корисним.

І, за можливості, є сенс це використовувати.
Але, якщо це допоміжна можливість.
А не головний файл із залежностями.

Тобто, як допоміжний “\*.lock” файл, чи щось подібне, що використовується для встановлення залежностей, то це добре.

А як головний файл залежностей, у який ми просто скинули все, що в нас встановлено, то це погано.

Тому іноді вам буде потрібно щонайменше два файли із залежностями.

- головний, з тим що саме ви додали.
- допоміжний, з тим що ви додали й усі залежності ваших залежностей. Автогенерований.

---

# Tools for dependency management / Інструменти для керування залежностями

## uv

Дуже корисний і потужний інструмент. Максимально раджу.

Додатково:

- Сайт з uv
  - https://github.com/astral-sh/uv
- Інструменти для міграції з інших інструментів до uv
  - https://github.com/mkniewallner/migrate-to-uv
  - https://github.com/stvnksslr/uv-migrator

## poetry

Відносно цікавий. Зараз, замість нього може бути краще використати `uv`.

Додатково:

- https://python-poetry.org/docs/
- https://realpython.com/dependency-management-python-poetry/
  - How to import requirements.txt into Poetry
    - https://timonweb.com/python/how-to-import-requirementstxt-into-poetry/
    - poetry add --group main $(cat requirements.txt | grep "#" --invert-match)

## pip + requirements.txt

Найпростіший варіант для невеликих проєктів для власного використання.

По факту, може бути у legacy чи дуже особливих проєктах.

Може бути корисним багатофайловий варіант.

Тобто у вас є файли із залежностями. Наприклад:

- `base.txt`
- `dev.txt`
- `prod.txt`

Вони знаходяться у теці `requirements`.

Також у корні проєкту є файл `requirements.txt`. У якому нічого не вказано, окрім використання `prod`.

Щодо `pip freeze`.

Як варіант, можете використовувати результат команди як додатковий файл (чи файли).
І із цього вже будуть встановлюватися залежності.

Але головний файл (чи файли) повинні бути тільки з головними залежностями та коментарями.

Тому для простих проєктів, з якими не пов’язані великі ризики щодо невеликої зміни залежностей, можно обійтись і без
“freeze”.

Додатково:

- https://pip.pypa.io/en/stable/reference/requirements-file-format/
- https://realpython.com/what-is-pip/

## pip-tools

Це як `pip + requirements.txt`, але з деякими покращеннями.

Додатково:

- https://github.com/jazzband/pip-tools

## pipenv

Додатково:

- https://packaging.python.org/en/latest/tutorials/managing-dependencies/
- https://pipenv.pypa.io/en/latest/
- https://realpython.com/pipenv-guide/

---

### Why not do "pip freeze" and why do comments? / Чому не робити "pip freeze" і навіщо коментарі?

Чому не варто просто робити купу `pip install bla` і потім `pip freeze > requirements.txt`?

Ви можете відчути дуже великий біль, коли проєкт трошки поживе і його потрібно буде оновлювати.

А особливо, коли потрібно буде викидати якись залежності.

І залежностей там, умовно, не 5, а 50+.

Ще краще, якщо автор проєкту не ви. І нікого з тих, хто знав, що й для чого додавалося, уже немає на зв'язку.

Тож, будь ласка:

- зберігайте десь перелік залежностей верхнього рівня
- Додавайте до них коментарі. Можна, також, робити коментарі до груп залежностей.

---

# Extra

Tool recommendations

- https://packaging.python.org/en/latest/guides/tool-recommendations/
